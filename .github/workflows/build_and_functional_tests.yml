name: Build and run functional tests using ragger through reusable workflow

# This workflow will build the app and then run functional tests using the Ragger framework upon Speculos emulation.
# It calls a reusable workflow developed by Ledger's internal developer team to build the application and upload the
# resulting binaries.
# It then calls another reusable workflow to run the Ragger tests on the compiled application binary.
#
# While this workflow is optional, having functional testing on your application is mandatory and this workflow and
# tooling environment is meant to be easy to use and adapt after forking your application

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:

jobs:
  build:
    name: Build application for NanoS with test image
    runs-on: ubuntu-latest
    container:
        image: alexisgrojean/full-test2:latest

    steps:
        - name: Clone
          uses: actions/checkout@v3
        - name: Build application
          shell: bash
          run: |
            BUILD_DEVICE_NAME="nanos" && \
            BIN_DIR_NAME="nanos" && \
            cargo ledger build ${BUILD_DEVICE_NAME} -- -Zunstable-options --out-dir=./build/${BIN_DIR_NAME}/bin/
